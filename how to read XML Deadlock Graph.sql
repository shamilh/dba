declare @deadlock xml
set @deadlock = '
<deadlock>   <victim-list>    <victimProcess id="process19b53b0c8"/>    <victimProcess id="process1df1e0cf8"/>   </victim-list>   <process-list>    <process id="process19b53b0c8" taskpriority="0" logused="0" waitresource="PAGE: 7:1:565239 " waittime="3024" ownerId="415224869" transactionname="SELECT" lasttranstarted="2015-04-19T00:33:58.947" XDES="0x3f64bebd0" lockMode="S" schedulerid="3" kpid="1184" status="suspended" spid="425" sbid="0" ecid="2" priority="0" trancount="0" lastbatchstarted="2015-04-19T00:33:58.947" lastbatchcompleted="2015-04-19T00:33:58.943" lastattention="1900-01-01T00:00:00.943" clientapp="w3wp@/LM/W3SVC/2/ROOT-1-130738664234735453" hostname="SolarWinds" hostpid="17348" isolationlevel="read committed (2)" xactid="415224869" currentdb="7" lockTimeout="4294967295" clientoption1="671088672" clientoption2="128056">     <executionStack>      <frame procname="adhoc" line="2" stmtstart="96" sqlhandle="0x0200000085dd443a7cdbd2ef20433010902bef147ad7a6fe0000000000000000000000000000000000000000">  SELECT Traps.*, NodesData.NodeID AS LinkNodeID, NodesData.Caption, NodesData.IP_Address, TrapVarbinds.OID, TrapVarbinds.OIDValue, TrapVarbinds.OIDName     FROM TrapVarbinds     LEFT OUTER JOIN Traps ON TrapVarbinds.TrapID = Traps.TrapID     LEFT OUTER JOIN NodesData On Traps.NodeID = NodesData.NodeID     LEFT OUTER JOIN NodesCustomProperties (NOLOCK) ON NodesData.NodeID = NodesCustomProperties.NodeID     WHERE (((((NodesCustomProperties.Hierarchy_Level LIKE &apos;Core&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Core Switch&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Firewall&apos;)))) AND ((((NodesData.NodeID = 14665) OR (NodesData.NodeID = 7723) OR (NodesData.NodeID = 14666) OR (NodesData.NodeID = 2130) OR (NodesData.NodeID = 14497) OR (NodesData.NodeID = 7945) OR (NodesData.NodeID = 7924) OR (NodesData.NodeID = 7925) OR (NodesData.NodeID = 7926) OR (NodesData.NodeID = 2124) OR (NodesData.NodeID = 4367) OR (NodesData.NodeID = 2171) OR (NodesData.NodeID = 14315) OR (NodesData.NodeID = 12555) OR (NodesData.N    </frame>      <frame procname="unknown" line="1" sqlhandle="0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">  unknown    </frame>     </executionStack>     <inputbuf>  (@periodStart datetime,@periodEnd datetime)     SELECT Traps.*, NodesData.NodeID AS LinkNodeID, NodesData.Caption, NodesData.IP_Address, TrapVarbinds.OID, TrapVarbinds.OIDValue, TrapVarbinds.OIDName     FROM TrapVarbinds     LEFT OUTER JOIN Traps ON TrapVarbinds.TrapID = Traps.TrapID     LEFT OUTER JOIN NodesData On Traps.NodeID = NodesData.NodeID     LEFT OUTER JOIN NodesCustomProperties (NOLOCK) ON NodesData.NodeID = NodesCustomProperties.NodeID     WHERE (((((NodesCustomProperties.Hierarchy_Level LIKE &apos;Core&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Core Switch&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Firewall&apos;)))) AND ((((NodesData.NodeID = 14665) OR (NodesData.NodeID = 7723) OR (NodesData.NodeID = 14666) OR (NodesData.NodeID = 2130) OR (NodesData.NodeID = 14497) OR (NodesData.NodeID = 7945) OR (NodesData.NodeID = 7924) OR (NodesData.NodeID = 7925) OR (NodesData.NodeID = 7926) OR (NodesData.NodeID = 2124) OR (NodesData.NodeID = 4367) OR (NodesData.NodeID = 2171) OR (NodesData.NodeID = 143   </inputbuf>    </process>    <process id="process1df1e0cf8" taskpriority="0" logused="0" waitresource="KEY: 7:72057944453218304 (7c153b02737c)" waittime="1283" ownerId="415224869" transactionname="SELECT" lasttranstarted="2015-04-19T00:33:58.947" XDES="0x2e5d074e0" lockMode="S" schedulerid="2" kpid="4376" status="suspended" spid="425" sbid="0" ecid="3" priority="0" trancount="0" lastbatchstarted="2015-04-19T00:33:58.947" lastbatchcompleted="2015-04-19T00:33:58.943" lastattention="1900-01-01T00:00:00.943" clientapp="w3wp@/LM/W3SVC/2/ROOT-1-130738664234735453" hostname="SolarWinds" hostpid="17348" isolationlevel="read committed (2)" xactid="415224869" currentdb="7" lockTimeout="4294967295" clientoption1="671088672" clientoption2="128056">     <executionStack>      <frame procname="adhoc" line="2" stmtstart="96" sqlhandle="0x0200000085dd443a7cdbd2ef20433010902bef147ad7a6fe0000000000000000000000000000000000000000">  SELECT Traps.*, NodesData.NodeID AS LinkNodeID, NodesData.Caption, NodesData.IP_Address, TrapVarbinds.OID, TrapVarbinds.OIDValue, TrapVarbinds.OIDName     FROM TrapVarbinds     LEFT OUTER JOIN Traps ON TrapVarbinds.TrapID = Traps.TrapID     LEFT OUTER JOIN NodesData On Traps.NodeID = NodesData.NodeID     LEFT OUTER JOIN NodesCustomProperties (NOLOCK) ON NodesData.NodeID = NodesCustomProperties.NodeID     WHERE (((((NodesCustomProperties.Hierarchy_Level LIKE &apos;Core&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Core Switch&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Firewall&apos;)))) AND ((((NodesData.NodeID = 14665) OR (NodesData.NodeID = 7723) OR (NodesData.NodeID = 14666) OR (NodesData.NodeID = 2130) OR (NodesData.NodeID = 14497) OR (NodesData.NodeID = 7945) OR (NodesData.NodeID = 7924) OR (NodesData.NodeID = 7925) OR (NodesData.NodeID = 7926) OR (NodesData.NodeID = 2124) OR (NodesData.NodeID = 4367) OR (NodesData.NodeID = 2171) OR (NodesData.NodeID = 14315) OR (NodesData.NodeID = 12555) OR (NodesData.N    </frame>      <frame procname="unknown" line="1" sqlhandle="0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">  unknown    </frame>     </executionStack>     <inputbuf>  (@periodStart datetime,@periodEnd datetime)     SELECT Traps.*, NodesData.NodeID AS LinkNodeID, NodesData.Caption, NodesData.IP_Address, TrapVarbinds.OID, TrapVarbinds.OIDValue, TrapVarbinds.OIDName     FROM TrapVarbinds     LEFT OUTER JOIN Traps ON TrapVarbinds.TrapID = Traps.TrapID     LEFT OUTER JOIN NodesData On Traps.NodeID = NodesData.NodeID     LEFT OUTER JOIN NodesCustomProperties (NOLOCK) ON NodesData.NodeID = NodesCustomProperties.NodeID     WHERE (((((NodesCustomProperties.Hierarchy_Level LIKE &apos;Core&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Core Switch&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Firewall&apos;)))) AND ((((NodesData.NodeID = 14665) OR (NodesData.NodeID = 7723) OR (NodesData.NodeID = 14666) OR (NodesData.NodeID = 2130) OR (NodesData.NodeID = 14497) OR (NodesData.NodeID = 7945) OR (NodesData.NodeID = 7924) OR (NodesData.NodeID = 7925) OR (NodesData.NodeID = 7926) OR (NodesData.NodeID = 2124) OR (NodesData.NodeID = 4367) OR (NodesData.NodeID = 2171) OR (NodesData.NodeID = 143   </inputbuf>    </process>    <process id="process3ff013c38" taskpriority="0" logused="10000" waittime="3141" schedulerid="1" kpid="4176" status="suspended" spid="425" sbid="0" ecid="1" priority="0" trancount="0" lastbatchstarted="2015-04-19T00:33:58.947" lastbatchcompleted="2015-04-19T00:33:58.943" lastattention="1900-01-01T00:00:00.943" clientapp="w3wp@/LM/W3SVC/2/ROOT-1-130738664234735453" hostname="SolarWinds" hostpid="17348" isolationlevel="read committed (2)" xactid="415224869" currentdb="7" lockTimeout="4294967295" clientoption1="671088672" clientoption2="128056">     <executionStack>      <frame procname="adhoc" line="2" stmtstart="96" sqlhandle="0x0200000085dd443a7cdbd2ef20433010902bef147ad7a6fe0000000000000000000000000000000000000000">  SELECT Traps.*, NodesData.NodeID AS LinkNodeID, NodesData.Caption, NodesData.IP_Address, TrapVarbinds.OID, TrapVarbinds.OIDValue, TrapVarbinds.OIDName     FROM TrapVarbinds     LEFT OUTER JOIN Traps ON TrapVarbinds.TrapID = Traps.TrapID     LEFT OUTER JOIN NodesData On Traps.NodeID = NodesData.NodeID     LEFT OUTER JOIN NodesCustomProperties (NOLOCK) ON NodesData.NodeID = NodesCustomProperties.NodeID     WHERE (((((NodesCustomProperties.Hierarchy_Level LIKE &apos;Core&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Core Switch&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Firewall&apos;)))) AND ((((NodesData.NodeID = 14665) OR (NodesData.NodeID = 7723) OR (NodesData.NodeID = 14666) OR (NodesData.NodeID = 2130) OR (NodesData.NodeID = 14497) OR (NodesData.NodeID = 7945) OR (NodesData.NodeID = 7924) OR (NodesData.NodeID = 7925) OR (NodesData.NodeID = 7926) OR (NodesData.NodeID = 2124) OR (NodesData.NodeID = 4367) OR (NodesData.NodeID = 2171) OR (NodesData.NodeID = 14315) OR (NodesData.NodeID = 12555) OR (NodesData.N    </frame>      <frame procname="unknown" line="1" sqlhandle="0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000">  unknown    </frame>     </executionStack>     <inputbuf>  (@periodStart datetime,@periodEnd datetime)     SELECT Traps.*, NodesData.NodeID AS LinkNodeID, NodesData.Caption, NodesData.IP_Address, TrapVarbinds.OID, TrapVarbinds.OIDValue, TrapVarbinds.OIDName     FROM TrapVarbinds     LEFT OUTER JOIN Traps ON TrapVarbinds.TrapID = Traps.TrapID     LEFT OUTER JOIN NodesData On Traps.NodeID = NodesData.NodeID     LEFT OUTER JOIN NodesCustomProperties (NOLOCK) ON NodesData.NodeID = NodesCustomProperties.NodeID     WHERE (((((NodesCustomProperties.Hierarchy_Level LIKE &apos;Core&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Core Switch&apos;) OR (NodesCustomProperties.Hierarchy_Level LIKE &apos;Firewall&apos;)))) AND ((((NodesData.NodeID = 14665) OR (NodesData.NodeID = 7723) OR (NodesData.NodeID = 14666) OR (NodesData.NodeID = 2130) OR (NodesData.NodeID = 14497) OR (NodesData.NodeID = 7945) OR (NodesData.NodeID = 7924) OR (NodesData.NodeID = 7925) OR (NodesData.NodeID = 7926) OR (NodesData.NodeID = 2124) OR (NodesData.NodeID = 4367) OR (NodesData.NodeID = 2171) OR (NodesData.NodeID = 143   </inputbuf>    </process>    <process id="process2a15c8cf8" taskpriority="0" logused="3987780" waitresource="PAGE: 7:1:1877657 " waittime="3149" ownerId="253159007" transactionname="DELETE" lasttranstarted="2015-04-18T02:27:45.117" XDES="0x263e42d28" lockMode="IX" schedulerid="3" kpid="4684" status="suspended" spid="68" sbid="0" ecid="0" priority="0" trancount="2" lastbatchstarted="2015-04-18T02:27:45.060" lastbatchcompleted="2015-04-18T02:27:45.060" lastattention="1900-01-01T00:00:00.060" clientapp="DatabaseMaintenance@Database-Maint.exe" hostname="SolarWinds" hostpid="18332" loginname="swconnector" isolationlevel="read uncommitted (1)" xactid="253159007" currentdb="7" lockTimeout="4294967295" clientoption1="673447968" clientoption2="128056">     <executionStack>      <frame procname="NetPerfMon.dbo.dbm_TrapMessages_DeleteStale" line="31" stmtstart="1552" stmtend="1660" sqlhandle="0x03000700d319a361f52dda007ca4000001000000000000000000000000000000000000000000000000000000">  DELETE TOP(10000) FROM Traps WHERE DateTime &lt; @date    </frame>     </executionStack>     <inputbuf>  Proc [Database Id = 7 Object Id = 1638078931]   </inputbuf>    </process>   </process-list>   <resource-list>    <pagelock fileid="1" pageid="565239" dbid="7" subresource="FULL" objectname="NetPerfMon.dbo.Traps" id="lock1cebc6200" mode="IX" associatedObjectId="72057944453414912">     <owner-list>      <owner id="process2a15c8cf8" mode="IX"/>     </owner-list>     <waiter-list>      <waiter id="process19b53b0c8" mode="S" requestType="wait"/>     </waiter-list>    </pagelock>    <keylock hobtid="72057944453218304" dbid="7" objectname="NetPerfMon.dbo.Traps" indexname="PK_Traps" id="lock294805b80" mode="X" associatedObjectId="72057944453218304">     <owner-list>      <owner id="process2a15c8cf8" mode="X"/>     </owner-list>     <waiter-list>      <waiter id="process1df1e0cf8" mode="S" requestType="wait"/>     </waiter-list>    </keylock>    <exchangeEvent id="Port3fdea6700" WaitType="e_waitPortOpen" nodeId="4">     <owner-list>      <owner id="process19b53b0c8"/>     </owner-list>     <waiter-list>      <waiter id="process3ff013c38"/>     </waiter-list>    </exchangeEvent>    <pagelock fileid="1" pageid="1877657" dbid="7" subresource="FULL" objectname="NetPerfMon.dbo.Traps" id="lock2dc7fc900" mode="S" associatedObjectId="72057944453414912">     <owner-list>      <owner id="process3ff013c38" mode="S"/>      <owner id="process1df1e0cf8" mode="S"/>     </owner-list>     <waiter-list>      <waiter id="process2a15c8cf8" mode="IX" requestType="wait"/>     </waiter-list>    </pagelock>   </resource-list>  </deadlock>  
'

select 
 [PagelockObject] = @deadlock.value('/deadlock[1]/resource-list[1]/pagelock[1]/@objectname', 'varchar(200)'),
 [DeadlockObject] = @deadlock.value('/deadlock[1]/resource-list[1]/objectlock[1]/@objectname', 'varchar(200)'),
 [KeyLockObject] = @deadlock.value('/deadlock[1]/resource-list[1]/keylock[1]/@objectname', 'varchar(200)'),
 [KeyLockIndex] = @deadlock.value('/deadlock[1]/resource-list[1]/keylock[1]/@indexname', 'varchar(200)'),
 [Victim] = case when Deadlock.Process.value('@id', 'varchar(50)') = @deadlock.value('/deadlock[1]/victim-list[1]/victimProcess[1]/@id', 'varchar(50)') then 1 else 0 end,
 [ProcessID] = Deadlock.Process.value('@id', 'varchar(50)'),
 [Procedure] = Deadlock.Process.value('executionStack[1]/frame[1]/@procname[1]', 'varchar(200)'),
 [LockMode] = Deadlock.Process.value('@lockMode', 'char(5)'),
 [Code] = Deadlock.Process.value('executionStack[1]/frame[1]', 'varchar(1000)'),
 --[ClientApp] = Deadlock.Process.value('@clientapp', 'varchar(100)'),
 [HostName] = Deadlock.Process.value('@hostname', 'varchar(20)'),
 [LoginName] = Deadlock.Process.value('@loginname', 'varchar(20)'),
 [TransactionTime] = Deadlock.Process.value('@lasttranstarted', 'datetime'),
 [BatchTime] = Deadlock.Process.value('@lastbatchstarted', 'datetime'),
 [InputBuffer] = Deadlock.Process.value('inputbuf[1]', 'varchar(1000)')
 from @deadlock.nodes('/deadlock/process-list/process') as Deadlock(Process)
